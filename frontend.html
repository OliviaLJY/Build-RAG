<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG System - Production Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: auto;
        }

        .badge.success {
            background: #10b981;
            color: white;
        }

        .badge.warning {
            background: #f59e0b;
            color: white;
        }

        .badge.info {
            background: #3b82f6;
            color: white;
        }

        .badge.cached {
            background: #8b5cf6;
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert.success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
        }

        .alert.error {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }

        .alert.info {
            background: #dbeafe;
            color: #1e40af;
            border: 2px solid #3b82f6;
        }

        .answer-box {
            background: #f9fafb;
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .answer-box .meta {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
            color: #6b7280;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .answer-box .meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .answer-box .answer-text {
            color: #1f2937;
            line-height: 1.6;
            font-size: 1.05em;
        }

        .sources {
            margin-top: 15px;
        }

        .sources h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .source-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #667eea;
            font-size: 0.9em;
            color: #4b5563;
        }

        .history-item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid #e5e7eb;
        }

        .history-item:hover {
            border-left-color: #667eea;
            transform: translateX(5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .history-item .question {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .history-item .meta {
            font-size: 0.85em;
            color: #6b7280;
            display: flex;
            gap: 15px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .api-key-display {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            word-break: break-all;
            margin: 15px 0;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .emoji {
            font-size: 1.2em;
        }

        .performance-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .performance-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #667eea);
            transition: width 0.3s;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ RAG System Dashboard</h1>
            <p>Production-Ready with Authentication & Caching</p>
        </div>

        <!-- API Key Setup Section -->
        <div id="setupSection">
            <div class="card">
                <h2><span class="emoji">üîë</span> Setup API Key</h2>
                <div id="setupAlert"></div>
                
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="keyName" placeholder="My App Key" value="Frontend User">
                </div>

                <div class="form-group">
                    <label>User ID</label>
                    <input type="text" id="userId" placeholder="user123" value="frontend_user">
                </div>

                <div class="form-group">
                    <label>Rate Limit (requests/minute)</label>
                    <input type="number" id="rateLimit" value="60" min="1" max="1000">
                </div>

                <button class="btn btn-primary" onclick="createAPIKey()">
                    <span class="emoji">‚ú®</span> Create API Key
                </button>

                <div style="margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="showExistingKeyInput()">
                        Already have a key?
                    </button>
                </div>

                <div id="existingKeyInput" class="hidden" style="margin-top: 20px;">
                    <div class="form-group">
                        <label>Paste Your API Key</label>
                        <input type="text" id="existingKey" placeholder="rag_...">
                    </div>
                    <button class="btn btn-primary" onclick="useExistingKey()">
                        Use This Key
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Application Section -->
        <div id="mainSection" class="hidden">
            <!-- Statistics -->
            <div class="grid">
                <div class="stat-card">
                    <h3>Cache Hit Rate</h3>
                    <div class="value" id="hitRate">0%</div>
                </div>
                <div class="stat-card">
                    <h3>Total Queries</h3>
                    <div class="value" id="totalQueries">0</div>
                </div>
                <div class="stat-card">
                    <h3>Avg Response Time</h3>
                    <div class="value" id="avgTime">0ms</div>
                </div>
                <div class="stat-card">
                    <h3>API Usage</h3>
                    <div class="value" id="apiUsage">0/60</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="card">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('query')">
                        <span class="emoji">üí¨</span> Query
                    </button>
                    <button class="tab" onclick="switchTab('history')">
                        <span class="emoji">üìú</span> History
                    </button>
                    <button class="tab" onclick="switchTab('settings')">
                        <span class="emoji">‚öôÔ∏è</span> Settings
                    </button>
                </div>

                <!-- Query Tab -->
                <div id="queryTab" class="tab-content active">
                    <div id="queryAlert"></div>

                    <div class="form-group">
                        <label>Ask a Question</label>
                        <textarea id="question" placeholder="What is machine learning?"></textarea>
                    </div>

                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button class="btn btn-primary" onclick="submitQuery()" id="queryBtn">
                            <span class="emoji">üîç</span> Ask Question
                        </button>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="useCache" checked>
                            <span>Use Cache</span>
                        </label>
                    </div>

                    <div id="answerSection"></div>
                </div>

                <!-- History Tab -->
                <div id="historyTab" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>Recent Queries</h3>
                        <button class="btn btn-secondary" onclick="loadHistory()">
                            <span class="emoji">üîÑ</span> Refresh
                        </button>
                    </div>
                    <div id="historyList"></div>
                </div>

                <!-- Settings Tab -->
                <div id="settingsTab" class="tab-content">
                    <h3 style="margin-bottom: 15px;">API Key Information</h3>
                    <div id="keyInfo"></div>

                    <h3 style="margin-top: 25px; margin-bottom: 15px;">Cache Statistics</h3>
                    <div id="cacheStats"></div>

                    <div style="margin-top: 25px;">
                        <button class="btn btn-secondary" onclick="clearCache()">
                            <span class="emoji">üóëÔ∏è</span> Clear Cache
                        </button>
                        <button class="btn btn-secondary" onclick="logout()" style="margin-left: 10px;">
                            <span class="emoji">üö™</span> Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let apiKey = localStorage.getItem('apiKey');
        let queryTimes = [];

        // Initialize
        if (apiKey) {
            showMainSection();
        }

        // Create API Key
        async function createAPIKey() {
            const name = document.getElementById('keyName').value;
            const userId = document.getElementById('userId').value;
            const rateLimit = parseInt(document.getElementById('rateLimit').value);

            try {
                const response = await fetch(`${API_BASE}/api/keys/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, user_id: userId, rate_limit: rateLimit })
                });

                const data = await response.json();

                if (response.ok) {
                    apiKey = data.api_key;
                    localStorage.setItem('apiKey', apiKey);
                    
                    showAlert('setupAlert', 'success', `
                        ‚úÖ API Key Created Successfully!<br>
                        <div class="api-key-display">${data.api_key}</div>
                        ‚ö†Ô∏è Save this key! It won't be shown again.
                    `);

                    setTimeout(() => {
                        showMainSection();
                    }, 3000);
                } else {
                    showAlert('setupAlert', 'error', `Error: ${data.detail}`);
                }
            } catch (error) {
                showAlert('setupAlert', 'error', `Connection error: ${error.message}`);
            }
        }

        // Use existing key
        function showExistingKeyInput() {
            document.getElementById('existingKeyInput').classList.remove('hidden');
        }

        function useExistingKey() {
            const key = document.getElementById('existingKey').value.trim();
            if (key) {
                apiKey = key;
                localStorage.setItem('apiKey', apiKey);
                showMainSection();
            }
        }

        // Submit Query
        async function submitQuery() {
            const question = document.getElementById('question').value.trim();
            const useCache = document.getElementById('useCache').checked;

            if (!question) {
                showAlert('queryAlert', 'error', 'Please enter a question');
                return;
            }

            const btn = document.getElementById('queryBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Thinking...';

            try {
                const startTime = Date.now();
                const response = await fetch(`${API_BASE}/api/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify({
                        question,
                        use_cache: useCache,
                        return_sources: true
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    displayAnswer(data);
                    queryTimes.push(data.response_time_ms);
                    updateStats();
                    showAlert('queryAlert', 'success', '‚úÖ Query completed successfully!');
                } else {
                    showAlert('queryAlert', 'error', `Error: ${data.detail}`);
                }
            } catch (error) {
                showAlert('queryAlert', 'error', `Connection error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="emoji">üîç</span> Ask Question';
            }
        }

        // Display Answer
        function displayAnswer(data) {
            const section = document.getElementById('answerSection');
            const cacheLabel = data.from_cache ? 
                '<span class="badge cached">‚ö° From Cache</span>' : 
                '<span class="badge info">üîÑ Fresh Query</span>';

            let sourcesHTML = '';
            if (data.sources && data.sources.length > 0) {
                sourcesHTML = `
                    <div class="sources">
                        <h4>üìö Sources:</h4>
                        ${data.sources.map((src, i) => `
                            <div class="source-item">${i + 1}. ${src}</div>
                        `).join('')}
                    </div>
                `;
            }

            section.innerHTML = `
                <div class="answer-box">
                    <div class="meta">
                        <span>‚è±Ô∏è ${data.response_time_ms.toFixed(2)}ms</span>
                        <span>${cacheLabel}</span>
                        <span>üÜî Query #${data.query_id}</span>
                    </div>
                    <div class="answer-text">${data.answer}</div>
                    ${sourcesHTML}
                </div>
            `;
        }

        // Load History
        async function loadHistory() {
            try {
                const response = await fetch(`${API_BASE}/api/history?limit=10`, {
                    headers: { 'X-API-Key': apiKey }
                });

                const data = await response.json();
                const list = document.getElementById('historyList');

                if (data.length === 0) {
                    list.innerHTML = '<div class="alert info">No queries yet. Try asking a question!</div>';
                    return;
                }

                list.innerHTML = data.map(item => `
                    <div class="history-item">
                        <div class="question">${item.question}</div>
                        <div class="meta">
                            <span>‚è±Ô∏è ${item.response_time_ms.toFixed(2)}ms</span>
                            <span>${item.from_cache ? '‚ö° Cached' : 'üîÑ Fresh'}</span>
                            <span>üïê ${new Date(item.timestamp).toLocaleString()}</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        // Update Statistics
        async function updateStats() {
            try {
                // Cache stats
                const cacheResponse = await fetch(`${API_BASE}/api/cache/stats`, {
                    headers: { 'X-API-Key': apiKey }
                });
                const cacheData = await cacheResponse.json();

                document.getElementById('hitRate').textContent = `${cacheData.hit_rate.toFixed(1)}%`;
                document.getElementById('totalQueries').textContent = cacheData.total_requests;

                // API usage
                const usageResponse = await fetch(`${API_BASE}/api/keys/usage`, {
                    headers: { 'X-API-Key': apiKey }
                });
                const usageData = await usageResponse.json();

                // Key info
                const keyResponse = await fetch(`${API_BASE}/api/keys/info`, {
                    headers: { 'X-API-Key': apiKey }
                });
                const keyData = await keyResponse.json();

                document.getElementById('apiUsage').textContent = 
                    `${usageData.recent_activity || 0}/${keyData.rate_limit}`;

                // Avg time
                if (queryTimes.length > 0) {
                    const avg = queryTimes.reduce((a, b) => a + b, 0) / queryTimes.length;
                    document.getElementById('avgTime').textContent = `${avg.toFixed(0)}ms`;
                }
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Load Key Info
        async function loadKeyInfo() {
            try {
                const response = await fetch(`${API_BASE}/api/keys/info`, {
                    headers: { 'X-API-Key': apiKey }
                });
                const data = await response.json();

                document.getElementById('keyInfo').innerHTML = `
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                        <div style="margin-bottom: 10px;"><strong>Name:</strong> ${data.name}</div>
                        <div style="margin-bottom: 10px;"><strong>User ID:</strong> ${data.user_id}</div>
                        <div style="margin-bottom: 10px;"><strong>Rate Limit:</strong> ${data.rate_limit} req/min</div>
                        <div style="margin-bottom: 10px;"><strong>Usage Count:</strong> ${data.usage_count}</div>
                        <div style="margin-bottom: 10px;"><strong>Key Prefix:</strong> <code>${data.key_prefix}</code></div>
                        <div style="margin-bottom: 10px;"><strong>Status:</strong> 
                            <span class="badge success">${data.is_active ? 'Active' : 'Inactive'}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading key info:', error);
            }
        }

        // Load Cache Stats
        async function loadCacheStats() {
            try {
                const response = await fetch(`${API_BASE}/api/cache/stats`, {
                    headers: { 'X-API-Key': apiKey }
                });
                const data = await response.json();

                const hitRatePercent = data.total_requests > 0 ? 
                    (data.hits / data.total_requests * 100).toFixed(1) : 0;

                document.getElementById('cacheStats').innerHTML = `
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                        <div style="margin-bottom: 10px;"><strong>Total Requests:</strong> ${data.total_requests}</div>
                        <div style="margin-bottom: 10px;"><strong>Cache Hits:</strong> ${data.hits}</div>
                        <div style="margin-bottom: 10px;"><strong>Cache Misses:</strong> ${data.misses}</div>
                        <div style="margin-bottom: 10px;"><strong>Hit Rate:</strong> ${data.hit_rate.toFixed(1)}%</div>
                        <div class="performance-bar">
                            <div class="performance-bar-fill" style="width: ${hitRatePercent}%"></div>
                        </div>
                        <div style="margin-top: 10px;"><strong>Cache Size:</strong> ${data.current_size}/${data.max_size}</div>
                        <div style="margin-top: 10px;"><strong>Evictions:</strong> ${data.evictions}</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading cache stats:', error);
            }
        }

        // Clear Cache
        async function clearCache() {
            if (confirm('Are you sure you want to clear the cache?')) {
                try {
                    await fetch(`${API_BASE}/api/cache/invalidate`, {
                        method: 'POST',
                        headers: { 'X-API-Key': apiKey }
                    });
                    showAlert('queryAlert', 'success', '‚úÖ Cache cleared successfully!');
                    updateStats();
                    loadCacheStats();
                } catch (error) {
                    console.error('Error clearing cache:', error);
                }
            }
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('apiKey');
                apiKey = null;
                location.reload();
            }
        }

        // Switch Tab
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');

            // Load data for specific tabs
            if (tab === 'history') {
                loadHistory();
            } else if (tab === 'settings') {
                loadKeyInfo();
                loadCacheStats();
            }
        }

        // Show Alert
        function showAlert(elementId, type, message) {
            const el = document.getElementById(elementId);
            el.innerHTML = `<div class="alert ${type}">${message}</div>`;
            setTimeout(() => {
                el.innerHTML = '';
            }, 5000);
        }

        // Show Main Section
        function showMainSection() {
            document.getElementById('setupSection').classList.add('hidden');
            document.getElementById('mainSection').classList.remove('hidden');
            updateStats();
        }

        // Auto-refresh stats every 10 seconds
        setInterval(() => {
            if (apiKey && !document.getElementById('mainSection').classList.contains('hidden')) {
                updateStats();
            }
        }, 10000);
    </script>
</body>
</html>

